name: Deploy Multi-Environnements

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '18'

jobs:
  # Job 1 : Tests (toujours exÃ©cutÃ©)
  test:
    name: ğŸ§ª Tests
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ“š Install dependencies
      run: npm install

    - name: ğŸ§ª Run tests
      run: npm test

    - name: âœ… Tests passed
      run: echo "âœ… All tests passed successfully"

  # Job 2 : Deploy Staging (seulement sur develop)
  deploy-staging:
    name: ğŸš€ Deploy Staging
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://api-todo-valentin-dauvier-staging.onrender.com

    steps:
    - name: ğŸš€ Trigger Staging Deploy
      run: |
        response=$(curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_STAGING }} -w "%{http_code}" -o /dev/null -s)
        if [ $response -eq 200 ] || [ $response -eq 201 ] || [ $response -eq 202 ]; then
          echo "âœ… Staging deployment triggered successfully (status $response)"
        else
          echo "âŒ Staging deployment failed with status $response"
          exit 1
        fi

    - name: â° Wait for deployment
      run: |
        echo "â±ï¸ Waiting 120 seconds for deployment to complete..."
        sleep 120

    - name: ğŸ” Health check Staging
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://api-todo-valentin-dauvier-staging.onrender.com/health)
        if [ $response -eq 200 ]; then
          echo "âœ… Staging is healthy"
        else
          echo "âš ï¸ Staging health check returned $response"
        fi

  # Job 3 : Deploy Production (seulement sur main)
deploy-production:
  name: ğŸš€ Deploy Production
  runs-on: ubuntu-latest
  needs: test
  if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  environment:
    name: production
    url: https://api-todo-valentin-dauvier-prod.onrender.com

  steps:
  - name: ğŸ“¥ Checkout
    uses: actions/checkout@v4
    with:
      fetch-depth: 0

  - name: ğŸ·ï¸ Create & Push Version Tag
    run: |
      # Compter les tags existants
      tag_count=$(git tag | grep -c "^v" || echo "0")
      new_version="v1.0.$((tag_count + 1))"
      echo "ğŸ“Œ New version: $new_version"

      # Configurer git
      git config user.name "GitHub Actions"
      git config user.email "actions@github.com"

      # CrÃ©er le tag et le pousser
      git tag -a "$new_version" -m "Release $new_version"
      git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} "$new_version"
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  - name: ğŸš€ Trigger Production Deploy
    run: |
      response=$(curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_PROD }} -w "%{http_code}" -o /dev/null -s)
      if [ $response -eq 200 ] || [ $response -eq 201 ] || [ $response -eq 202 ]; then
        echo "âœ… Production deployment triggered successfully (status $response)"
      else
        echo "âŒ Production deployment failed with status $response"
        exit 1
      fi

  - name: â° Wait for deployment
    run: |
      echo "â±ï¸ Waiting 120 seconds for deployment to complete..."
      sleep 120

  - name: ğŸ” Health check Production
    run: |
      response=$(curl -s -o /dev/null -w "%{http_code}" https://api-todo-valentin-dauvier-prod.onrender.com/health)
      if [ $response -eq 200 ]; then
        echo "âœ… Production is healthy"
      else
        echo "âŒ Production health check failed with status $response"
        exit 1
      fi

  - name: ğŸ‰ Deployment Complete
    run: |
      echo "ğŸ‰ Deployment to production complete!"
      echo "ğŸ“Œ Version: $new_version"
      echo "ğŸŒ URL: https://api-todo-valentin-dauvier-prod.onrender.com"